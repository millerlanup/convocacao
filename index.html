<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Escalas - FLAP (v6 Corrigido)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: 80vh;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .production-mode {
            background: #28a745;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-badge {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .btn-logout {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Login simplificado */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .login-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 1.5rem;
        }

        .quick-login {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        /* Dashboard */
        .dashboard {
            padding: 20px;
        }

        .dashboard-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-footer .btn {
            width: auto;
            padding: 10px 20px;
        }

        .hidden {
            display: none !important;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.info {
            background: #17a2b8;
        }

        .toast.warning {
            background: #ffc107;
            color: #212529;
        }

        .loading {
            color: #6c757d;
            font-style: italic;
        }

        .badge {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }

        .badge.success {
            background: #28a745;
        }

        .badge.warning {
            background: #ffc107;
            color: #212529;
        }

        .badge.danger {
            background: #dc3545;
        }

        .badge.inactive {
            background: #6c757d;
        }

        /* Indicador de processamento */
        .processing-indicator {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .processing-indicator.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="production-mode">
        ✅ SISTEMA EM PRODUÇÃO - v6 CORRIGIDO
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h2 class="login-title">Sistema de Escalas - FLAP</h2>
        <div class="quick-login">
            <button class="btn btn-primary" onclick="loginAs('rh')">Entrar como RH</button>
            <button class="btn btn-success" onclick="loginAs('marcio')">Entrar como MARCIO</button>
            <button class="btn btn-success" onclick="loginAs('joao')">Entrar como JOÃO</button>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainContainer" class="container hidden">
        <div class="header">
            <h1>Sistema de Escalas - FLAP</h1>
            <div class="user-info">
                <span class="user-badge" id="userBadge"></span>
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>
        </div>

        <!-- Processing Indicator -->
        <div id="processingIndicator" class="processing-indicator">
            <strong>⏳ Processando...</strong> <span id="processingMessage"></span>
        </div>

        <!-- RH Dashboard -->
        <div id="rhDashboard" class="dashboard hidden">
            <h2 class="dashboard-title">Dashboard RH</h2>
            
            <div class="cards-grid">
                <div class="card">
                    <div class="card-title">Demanda Atual</div>
                    <div id="currentDemand">
                        <span class="loading">Carregando...</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Escalas Recebidas</div>
                    <div id="receivedScales">
                        <span class="loading">Calculando...</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Total de Profissionais</div>
                    <div id="totalSelected">
                        <span class="loading">Calculando...</span>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="openCreateDemand()">Criar Nova Demanda</button>
                <button class="btn btn-primary" onclick="verEscalaUnificada()">Ver Escala Unificada</button>
                <button class="btn btn-info" onclick="atualizarDados()">🔄 Atualizar Dados</button>
                <button class="btn btn-warning" onclick="enviarConvocacao()">Enviar Convocação</button>
                <button class="btn btn-warning" onclick="notificarGerentes()">Notificar Gerentes</button>
                <button class="btn btn-danger" onclick="encerrarDemandaCorrigido()">Encerrar Demanda</button>
            </div>

            <div id="unifiedTable" class="table-container hidden">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" onchange="toggleAll()"></th>
                            <th>Nome</th>
                            <th>Telefone</th>
                            <th>Função</th>
                            <th>Gerente</th>
                            <th>Status RH</th>
                            <th>Data Convocação</th>
                            <th>Resposta</th>
                            <th>Data Resposta</th>
                        </tr>
                    </thead>
                    <tbody id="unifiedTableBody">
                        <tr>
                            <td colspan="9" style="text-align: center;">
                                <span class="loading">Carregando dados...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Gerente Dashboard -->
        <div id="gerenteDashboard" class="dashboard hidden">
            <h2 class="dashboard-title">Dashboard Gerente - <span id="gerenteName"></span></h2>
            
            <div class="card">
                <div class="card-title">Demanda Atual</div>
                <div id="gerenteDemandInfo">
                    <span class="loading">Carregando demanda...</span>
                </div>
            </div>

            <div id="gerenteScaleStatus" class="card hidden">
                <div class="card-title">Status da Escala</div>
                <div id="gerenteScaleInfo">
                    <span style="color: green;">✅ Escala já enviada para esta demanda</span>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="selecionarTodos()">Selecionar Todos</button>
                <button class="btn btn-primary" onclick="desselecionarTodos()">Desselecionar Todos</button>
                <button id="btnEnviarEscala" class="btn btn-success" onclick="enviarEscala()">Enviar Escala</button>
                <button class="btn btn-warning" onclick="recarregarDemanda()">Recarregar Demanda</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllGerente" onchange="toggleAllGerente()"></th>
                            <th>Nome</th>
                            <th>Telefone</th>
                            <th>Função</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="gerenteTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Criar Demanda -->
    <div id="createDemandModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Criar Nova Demanda</div>
            <form id="createDemandForm">
                <div class="form-group">
                    <label for="local">Local:</label>
                    <select id="local" required>
                        <option value="">Selecione...</option>
                        <option value="Estadio Nilton Santos">Estádio Nilton Santos</option>
                        <option value="Sao Januario">São Januário</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="evento">Evento:</label>
                    <input type="text" id="evento" placeholder="Ex: Botafogo x Flamengo - Campeonato Brasileiro" required>
                </div>
                <div class="form-group">
                    <label for="dataEvento">Data do Evento:</label>
                    <input type="date" id="dataEvento" required>
                </div>
                <div class="form-group">
                    <label for="dataLimite">Data Limite para Escala:</label>
                    <input type="datetime-local" id="dataLimite" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('createDemandModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Criar Demanda</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Configurações
        const CONFIG = {
            SHEETS_API_KEY: 'AIzaSyCCvdIC0TnINvn5s3TPwufzos-6sxZYFHk',
            UNIFIED_SHEET_ID: '1LjjOs91sTY72xbCVKS_nK8cyY8sWEJa1cV_JNLsYszM',
            MARCIO_SHEET_ID: '1SvKZBZ3FdZRFk5iXxg26WFqMgMiyqMAmQt2VzCY31iY',
            JOAO_SHEET_ID: '1qxd-74E1VOJccO7FDOy18TX6VznvNTfHb7sSOcMTUI4',
            N8N_WEBHOOK: 'https://n8n.hublanup.com.br/webhook',
            N8N_WEBHOOK_CONVOCACAO: 'https://n8n.hublanup.com.br/webhook/convocacao-sheets-seven7-empresa',
            NUMERO_TESTE: '5511953909792',
            TEMPLATE_ID: '68cc74d8ae6ca49eaf1c334e',
            DRIVE_FOLDER_ID: '16nTdbqpgUgxXjR8A1CUlyPNMpyF6gs3O'
        };

        // Dados compartilhados
        const SHARED_DATA = {
            demandaAtual: null,
            dadosUnificados: [],
            escalasEnviadas: {},
            gerentes: {
                marcio: [
                    { nome: 'CARLOS SILVA', telefone: '11953909792', funcao: 'SEGURANÇA', status: 'ATIVO' },
                    { nome: 'ANA COSTA', telefone: '11999999992', funcao: 'AUXILIAR', status: 'ATIVO' },
                    { nome: 'PEDRO SANTOS', telefone: '11999999993', funcao: 'COORDENADOR', status: 'ATIVO' }
                ],
                joao: [
                    { nome: 'MARIA OLIVEIRA', telefone: '11999999994', funcao: 'SEGURANÇA', status: 'ATIVO' },
                    { nome: 'JOÃO SOUZA', telefone: '11999999995', funcao: 'AUXILIAR', status: 'ATIVO' },
                    { nome: 'LUCAS LIMA', telefone: '11999999996', funcao: 'SUPERVISOR', status: 'ATIVO' }
                ]
            }
        };

        let currentUser = null;
        let selectedProfessionals = new Set();

        // Setup inicial
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('createDemandForm').addEventListener('submit', handleCreateDemand);
            console.log('Sistema de Escalas FLAP v6 - Modo Produção Corrigido');
        });

        // Login
        function loginAs(type) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('hidden');
            
            if (type === 'rh') {
                currentUser = { type: 'rh', name: 'RH' };
                document.getElementById('rhDashboard').classList.remove('hidden');
                loadRHDashboard();
            } else {
                currentUser = { type: 'gerente', name: type.toUpperCase(), id: type };
                document.getElementById('gerenteDashboard').classList.remove('hidden');
                document.getElementById('gerenteName').textContent = currentUser.name;
                loadGerenteData(type);
            }
            
            document.getElementById('userBadge').textContent = currentUser.name;
            showToast(`Logado como ${currentUser.name}`, 'success');
        }

        function logout() {
            location.reload();
        }

        // Indicador de processamento
        function showProcessing(message) {
            const indicator = document.getElementById('processingIndicator');
            const msgElement = document.getElementById('processingMessage');
            msgElement.textContent = message;
            indicator.classList.add('show');
        }

        function hideProcessing() {
            document.getElementById('processingIndicator').classList.remove('show');
        }

        // Função para carregar demanda ativa
        async function loadDemandaAtiva() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.UNIFIED_SHEET_ID}/values/eventos_criados?key=${CONFIG.SHEETS_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    // Procurar por demanda ativa começando do fim
                    for (let i = data.values.length - 1; i >= 1; i--) {
                        const row = data.values[i];
                        const status = row[5] || '';
                        
                        if (status.toUpperCase().trim() === 'ATIVO') {
                            SHARED_DATA.demandaAtual = {
                                local: row[0] || '',
                                evento: row[1] || '',
                                dataEvento: row[2] || '',
                                dataLimite: row[3] || '',
                                dataCriacao: row[4] || '',
                                status: row[5] || '',
                                rowIndex: i
                            };
                            console.log('Demanda ativa encontrada:', SHARED_DATA.demandaAtual);
                            return true;
                        }
                    }
                }
                
                SHARED_DATA.demandaAtual = null;
                return false;
                
            } catch (error) {
                console.error('Erro ao carregar demanda:', error);
                return false;
            }
        }

        // Função para carregar dados unificados
        async function carregarDadosUnificados() {
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.UNIFIED_SHEET_ID}/values/Dados_unificados?key=${CONFIG.SHEETS_API_KEY}`
                );
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    SHARED_DATA.dadosUnificados = data.values.slice(1);
                    
                    // Contar gerentes únicos e escalas
                    const gerentesUnicos = [...new Set(SHARED_DATA.dadosUnificados.map(r => r[3]).filter(g => g))];
                    
                    // Verificar escalas enviadas por cada gerente
                    SHARED_DATA.escalasEnviadas = {};
                    gerentesUnicos.forEach(gerente => {
                        SHARED_DATA.escalasEnviadas[gerente.toLowerCase()] = true;
                    });
                    
                    // Atualizar contadores
                    document.getElementById('receivedScales').innerHTML = 
                        `<strong>${gerentesUnicos.length}</strong> escalas recebidas`;
                    document.getElementById('totalSelected').innerHTML = 
                        `<strong>${SHARED_DATA.dadosUnificados.length}</strong> profissionais`;
                    
                    console.log(`Dados unificados carregados: ${SHARED_DATA.dadosUnificados.length} profissionais`);
                } else {
                    SHARED_DATA.dadosUnificados = [];
                    document.getElementById('receivedScales').innerHTML = '<strong>0</strong> escalas recebidas';
                    document.getElementById('totalSelected').innerHTML = '<strong>0</strong> profissionais';
                }
            } catch (error) {
                console.error('Erro ao carregar dados unificados:', error);
                document.getElementById('receivedScales').innerHTML = 'Erro ao carregar';
                document.getElementById('totalSelected').innerHTML = 'Erro ao carregar';
            }
        }

        // RH Functions
        async function loadRHDashboard() {
            document.getElementById('currentDemand').innerHTML = '<span class="loading">Carregando...</span>';
            document.getElementById('receivedScales').innerHTML = '<span class="loading">Calculando...</span>';
            document.getElementById('totalSelected').innerHTML = '<span class="loading">Calculando...</span>';
            
            // Carregar demanda ativa
            const hasDemanda = await loadDemandaAtiva();
            
            if (hasDemanda && SHARED_DATA.demandaAtual) {
                updateDemandDisplay();
            } else {
                document.getElementById('currentDemand').innerHTML = 'Nenhuma demanda ativa';
            }
            
            // Carregar dados unificados automaticamente
            await carregarDadosUnificados();
        }

        function updateDemandDisplay() {
            if (SHARED_DATA.demandaAtual) {
                const statusClass = SHARED_DATA.demandaAtual.status === 'ATIVO' ? 'success' : 'inactive';
                const demandaHtml = `
                    <strong>${SHARED_DATA.demandaAtual.evento}</strong><br>
                    Local: ${SHARED_DATA.demandaAtual.local}<br>
                    Data Evento: ${SHARED_DATA.demandaAtual.dataEvento}<br>
                    Data Limite: ${SHARED_DATA.demandaAtual.dataLimite}<br>
                    Status: <span class="badge ${statusClass}">${SHARED_DATA.demandaAtual.status}</span>
                `;
                
                // Atualizar display do RH
                if (document.getElementById('currentDemand')) {
                    document.getElementById('currentDemand').innerHTML = demandaHtml;
                }
                
                // Atualizar display do gerente
                if (document.getElementById('gerenteDemandInfo')) {
                    document.getElementById('gerenteDemandInfo').innerHTML = demandaHtml;
                    
                    // Verificar se o gerente já enviou escala
                    if (currentUser && currentUser.type === 'gerente') {
                        const jaEnviou = SHARED_DATA.escalasEnviadas[currentUser.id];
                        if (jaEnviou) {
                            document.getElementById('gerenteScaleStatus').classList.remove('hidden');
                            document.getElementById('btnEnviarEscala').disabled = true;
                            document.getElementById('btnEnviarEscala').textContent = 'Escala Já Enviada';
                        } else {
                            document.getElementById('gerenteScaleStatus').classList.add('hidden');
                            document.getElementById('btnEnviarEscala').disabled = false;
                            document.getElementById('btnEnviarEscala').textContent = 'Enviar Escala';
                        }
                    }
                }
            }
        }

        // Atualizar dados manualmente
        async function atualizarDados() {
            showToast('Atualizando dados...', 'info');
            await loadRHDashboard();
            showToast('Dados atualizados!', 'success');
        }

        // Ver escala unificada
        async function verEscalaUnificada() {
            const table = document.getElementById('unifiedTable');
            table.classList.toggle('hidden');
            
            if (!table.classList.contains('hidden')) {
                // Atualizar tabela com dados já carregados
                atualizarTabelaUnificada();
                
                // Recarregar dados mais recentes
                await carregarDadosUnificados();
                atualizarTabelaUnificada();
            }
        }

        function atualizarTabelaUnificada() {
            const tbody = document.getElementById('unifiedTableBody');
            
            if (SHARED_DATA.dadosUnificados.length > 0) {
                tbody.innerHTML = SHARED_DATA.dadosUnificados.map((row, index) => {
                    const statusClass = row[5] === 'APROVADO' ? 'success' : 'warning';
                    const resposta = row[8] || '-';
                    const respostaClass = resposta === 'ACEITO' ? 'success' : resposta === 'RECUSO' ? 'danger' : '';
                    
                    return `
                        <tr>
                            <td><input type="checkbox" value="${index}" onchange="toggleSelection(${index})"></td>
                            <td>${row[0] || ''}</td>
                            <td>${row[1] || ''}</td>
                            <td>${row[2] || ''}</td>
                            <td>${row[3] || ''}</td>
                            <td><span class="badge ${statusClass}">${row[5] || 'PENDENTE'}</span></td>
                            <td>${row[9] || '-'}</td>
                            <td>${resposta !== '-' ? `<span class="badge ${respostaClass}">${resposta}</span>` : '-'}</td>
                            <td>${row[10] || '-'}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Nenhuma escala recebida ainda</td></tr>';
            }
        }

        function openCreateDemand() {
            document.getElementById('createDemandModal').classList.add('show');
        }

        async function handleCreateDemand(e) {
            e.preventDefault();
            
            const formData = {
                local: document.getElementById('local').value,
                evento: document.getElementById('evento').value,
                dataEvento: document.getElementById('dataEvento').value,
                dataLimite: document.getElementById('dataLimite').value,
                dataCriacao: new Date().toISOString(),
                status: 'ATIVO'
            };
            
            try {
                showProcessing('Criando nova demanda e inativando anterior...');
                
                // 1. Inativar demanda anterior se existir
                if (SHARED_DATA.demandaAtual) {
                    await inativarDemandaAnterior();
                    await consolidarDadosAnteriores();
                }
                
                // 2. Criar nova demanda
                const response = await fetch(`${CONFIG.N8N_WEBHOOK}/criar-demanda`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    // 3. Limpar dados unificados
                    await limparDadosUnificados();
                    
                    // 4. Criar sheet de credenciamento
                    await criarSheetCredenciamento(formData.evento);
                    
                    showToast('Demanda criada com sucesso!', 'success');
                    closeModal('createDemandModal');
                    SHARED_DATA.demandaAtual = formData;
                    SHARED_DATA.dadosUnificados = [];
                    SHARED_DATA.escalasEnviadas = {};
                    updateDemandDisplay();
                    document.getElementById('createDemandForm').reset();
                } else {
                    throw new Error('Erro ao criar demanda');
                }
            } catch (error) {
                console.error(error);
                showToast('Erro ao criar demanda', 'error');
            } finally {
                hideProcessing();
            }
        }

        async function inativarDemandaAnterior() {
            try {
                await fetch(`${CONFIG.N8N_WEBHOOK}/inativar-demanda`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        demandaId: SHARED_DATA.demandaAtual.evento,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (error) {
                console.error('Erro ao inativar demanda anterior:', error);
            }
        }

        async function consolidarDadosAnteriores() {
            if (SHARED_DATA.dadosUnificados.length === 0) return;
            
            try {
                await fetch(`${CONFIG.N8N_WEBHOOK}/consolidar-dados`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        demandaId: SHARED_DATA.demandaAtual.evento,
                        dados: SHARED_DATA.dadosUnificados,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (error) {
                console.error('Erro ao consolidar dados:', error);
            }
        }

        async function limparDadosUnificados() {
            try {
                await fetch(`${CONFIG.N8N_WEBHOOK}/limpar-dados-unificados`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (error) {
                console.error('Erro ao limpar dados unificados:', error);
            }
        }

        async function criarSheetCredenciamento(evento) {
            try {
                await fetch(`${CONFIG.N8N_WEBHOOK}/criar-credenciamento`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        evento: evento,
                        driveFolder: CONFIG.DRIVE_FOLDER_ID,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (error) {
                console.error('Erro ao criar sheet de credenciamento:', error);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Função CORRIGIDA: Encerrar Demanda
        async function encerrarDemandaCorrigido() {
            if (!SHARED_DATA.demandaAtual) {
                showToast('Nenhuma demanda ativa', 'error');
                return;
            }
            
            if (!confirm('Deseja realmente encerrar a demanda? Os dados serão consolidados e a demanda ficará inativa.')) {
                return;
            }
            
            try {
                showProcessing('Encerrando demanda e consolidando dados...');
                
                // 1. Consolidar dados se existirem
                if (SHARED_DATA.dadosUnificados.length > 0) {
                    await consolidarDadosAnteriores();
                    
                    // Criar sheet de credenciamento final
                    await criarSheetCredenciamento(SHARED_DATA.demandaAtual.evento);
                }
                
                // 2. Inativar demanda
                await inativarDemandaAnterior();
                
                // 3. Limpar dados unificados
                await limparDadosUnificados();
                
                showToast('Demanda encerrada com sucesso!', 'success');
                
                // Limpar dados locais
                SHARED_DATA.demandaAtual = null;
                SHARED_DATA.dadosUnificados = [];
                SHARED_DATA.escalasEnviadas = {};
                
                // Atualizar interface
                document.getElementById('currentDemand').innerHTML = 'Nenhuma demanda ativa';
                document.getElementById('receivedScales').innerHTML = '<strong>0</strong> escalas recebidas';
                document.getElementById('totalSelected').innerHTML = '<strong>0</strong> profissionais';
                
                // Se a tabela estiver aberta, limpar
                const tbody = document.getElementById('unifiedTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Nenhuma escala disponível</td></tr>';
                }
            } catch (error) {
                console.error('Erro ao encerrar demanda:', error);
                showToast('Erro ao encerrar demanda', 'error');
            } finally {
                hideProcessing();
            }
        }

        // FUNÇÃO ATUALIZADA: Enviar Convocação com registro de DATA_CONVOCACAO
        async function enviarConvocacao() {
            // Verificar se há profissionais selecionados
            const checkboxes = document.querySelectorAll('#unifiedTableBody input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                showToast('Selecione pelo menos um profissional na tabela', 'error');
                return;
            }
            
            if (!SHARED_DATA.demandaAtual) {
                showToast('Nenhuma demanda ativa', 'error');
                return;
            }
            
            // Coletar dados dos profissionais selecionados
            const profissionaisSelecionados = [];
            const indicesSelecionados = [];
            
            checkboxes.forEach(cb => {
                const index = parseInt(cb.value);
                indicesSelecionados.push(index);
                const row = SHARED_DATA.dadosUnificados[index];
                if (row) {
                    profissionaisSelecionados.push({
                        nome: row[0],
                        telefone: row[1],
                        funcao: row[2],
                        gerente: row[3],
                        rowIndex: index + 2 // +2 porque a primeira linha é o cabeçalho
                    });
                }
            });
            
            // CONFIGURAÇÃO
            const EMPRESA = 'FLAP';
            const MODO_TESTE = false;
            
            if (MODO_TESTE) {
                console.log('⚠️ MODO TESTE ATIVADO');
                profissionaisSelecionados.length = 1;
                profissionaisSelecionados[0].telefone = CONFIG.NUMERO_TESTE;
            }
            
            // Confirmar envio
            const mensagemConfirmacao = MODO_TESTE ? 
                `⚠️ MODO TESTE: Enviar para ${CONFIG.NUMERO_TESTE}?` :
                `Enviar convocação para ${profissionaisSelecionados.length} profissional(is)?`;
                
            if (!confirm(mensagemConfirmacao)) {
                return;
            }
            
            try {
                showProcessing(`Enviando convocação para ${profissionaisSelecionados.length} profissional(is)...`);
                
                const dataConvocacao = new Date().toISOString();
                
                // Preparar payload com DATA_CONVOCACAO
                const payload = {
                    demanda: {
                        empresa: EMPRESA,
                        evento: SHARED_DATA.demandaAtual.evento,
                        local: SHARED_DATA.demandaAtual.local,
                        data: SHARED_DATA.demandaAtual.dataEvento
                    },
                    profissionais: profissionaisSelecionados.map(prof => ({
                        nome: prof.nome,
                        telefone: prof.telefone.toString().replace(/\D/g, ''),
                        funcao: prof.funcao,
                        gerente: prof.gerente,
                        dataConvocacao: dataConvocacao,
                        rowIndex: prof.rowIndex
                    })),
                    lote: 1,
                    total_lotes: 1,
                    sistema: 'seven7chat',
                    registrarDataConvocacao: true
                };
                
                console.log('📤 Enviando convocação com registro de data:', payload);
                
                const response = await fetch(CONFIG.N8N_WEBHOOK_CONVOCACAO, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log('📥 Resposta:', result);
                
                if (response.ok && result.sucesso !== false) {
                    // Atualizar localmente a data de convocação
                    indicesSelecionados.forEach(index => {
                        if (SHARED_DATA.dadosUnificados[index]) {
                            SHARED_DATA.dadosUnificados[index][9] = dataConvocacao;
                        }
                    });
                    
                    showToast(`✅ Convocação enviada para ${profissionaisSelecionados.length} profissional(is)!`, 'success');
                    
                    // Limpar seleções
                    checkboxes.forEach(cb => cb.checked = false);
                    document.getElementById('selectAll').checked = false;
                    selectedProfessionals.clear();
                    
                    // Atualizar tabela
                    atualizarTabelaUnificada();
                    
                    // Recarregar dados em 2 segundos
                    setTimeout(() => {
                        carregarDadosUnificados();
                    }, 2000);
                } else {
                    throw new Error(result.erro || 'Erro no envio');
                }
            } catch (error) {
                console.error('❌ Erro:', error);
                showToast(`Erro: ${error.message}`, 'error');
            } finally {
                hideProcessing();
            }
        }

        // Gerente Functions
        async function loadGerenteData(gerente) {
            document.getElementById('gerenteDemandInfo').innerHTML = '<span class="loading">Carregando demanda...</span>';
            
            // Carregar demanda ativa
            const hasDemanda = await loadDemandaAtiva();
            
            // Carregar dados unificados para verificar se já enviou
            await carregarDadosUnificados();
            
            if (hasDemanda && SHARED_DATA.demandaAtual) {
                updateDemandDisplay();
                
                // Se demanda está inativa, desabilitar envio
                if (SHARED_DATA.demandaAtual.status !== 'ATIVO') {
                    document.getElementById('btnEnviarEscala').disabled = true;
                    document.getElementById('btnEnviarEscala').textContent = 'Demanda Encerrada';
                    showToast('Demanda está encerrada', 'warning');
                }
            } else {
                document.getElementById('gerenteDemandInfo').innerHTML = 
                    '<span style="color: #6c757d;">Nenhuma demanda ativa</span>';
                document.getElementById('btnEnviarEscala').disabled = true;
            }
            
            // Carregar profissionais do gerente
            const tbody = document.getElementById('gerenteTableBody');
            const data = SHARED_DATA.gerentes[gerente] || [];
            
            tbody.innerHTML = data.map((prof, index) => `
                <tr>
                    <td><input type="checkbox" value="${index}"></td>
                    <td>${prof.nome}</td>
                    <td>${prof.telefone}</td>
                    <td>${prof.funcao}</td>
                    <td>${prof.status}</td>
                </tr>
            `).join('');
        }

        async function recarregarDemanda() {
            showToast('Recarregando demanda...', 'info');
            document.getElementById('gerenteDemandInfo').innerHTML = '<span class="loading">Carregando...</span>';
            
            const hasDemanda = await loadDemandaAtiva();
            await carregarDadosUnificados();
            
            if (hasDemanda && SHARED_DATA.demandaAtual) {
                updateDemandDisplay();
                showToast('Demanda atualizada!', 'success');
            } else {
                document.getElementById('gerenteDemandInfo').innerHTML = 
                    '<span style="color: #6c757d;">Nenhuma demanda ativa</span>';
                showToast('Nenhuma demanda encontrada', 'info');
            }
        }

        // Enviar escala (gerente)
        async function enviarEscala() {
            const checkboxes = document.querySelectorAll('#gerenteTableBody input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                showToast('Selecione pelo menos um profissional', 'error');
                return;
            }
            
            if (!SHARED_DATA.demandaAtual || SHARED_DATA.demandaAtual.status !== 'ATIVO') {
                showToast('Nenhuma demanda ativa', 'error');
                return;
            }
            
            // Verificar se já enviou
            if (SHARED_DATA.escalasEnviadas[currentUser.id]) {
                showToast('Você já enviou uma escala para esta demanda', 'warning');
                return;
            }
            
            try {
                showToast('Enviando escala...', 'info');
                
                const gerente = currentUser.name.toLowerCase();
                const selected = Array.from(checkboxes).map(cb => 
                    SHARED_DATA.gerentes[gerente][cb.value]
                );
                
                const response = await fetch(`${CONFIG.N8N_WEBHOOK}/enviar-escala-gerente`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        gerente: currentUser.name,
                        demandaId: SHARED_DATA.demandaAtual.evento,
                        profissionais: selected,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    SHARED_DATA.escalasEnviadas[currentUser.id] = true;
                    showToast('Escala enviada com sucesso!', 'success');
                    updateDemandDisplay();
                    desselecionarTodos();
                } else {
                    throw new Error('Erro ao enviar escala');
                }
            } catch (error) {
                console.error(error);
                showToast('Erro ao enviar escala', 'error');
            }
        }

        // Notificar gerentes
        async function notificarGerentes() {
            if (!SHARED_DATA.demandaAtual) {
                showToast('Crie uma demanda primeiro', 'error');
                return;
            }
            
            try {
                showToast('Notificando gerentes...', 'info');
                
                const response = await fetch(`${CONFIG.N8N_WEBHOOK}/notificar-gerentes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        evento: SHARED_DATA.demandaAtual.evento,
                        dataLimite: SHARED_DATA.demandaAtual.dataLimite,
                        local: SHARED_DATA.demandaAtual.local,
                        numeroTeste: CONFIG.NUMERO_TESTE
                    })
                });
                
                showToast('Notificação enviada!', 'success');
            } catch (error) {
                console.error(error);
                showToast('Erro ao notificar', 'error');
            }
        }

        // Funções de seleção
        function toggleSelection(index) {
            if (selectedProfessionals.has(index)) {
                selectedProfessionals.delete(index);
            } else {
                selectedProfessionals.add(index);
            }
        }

        function toggleAll() {
            const checkboxes = document.querySelectorAll('#unifiedTableBody input[type="checkbox"]');
            const selectAll = document.getElementById('selectAll');
            
            checkboxes.forEach((cb, index) => {
                cb.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedProfessionals.add(index);
                } else {
                    selectedProfessionals.delete(index);
                }
            });
        }

        function toggleAllGerente() {
            const selectAll = document.getElementById('selectAllGerente');
            document.querySelectorAll('#gerenteTableBody input[type="checkbox"]').forEach(cb => {
                cb.checked = selectAll.checked;
            });
        }

        function selecionarTodos() {
            document.querySelectorAll('#gerenteTableBody input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            document.getElementById('selectAllGerente').checked = true;
        }

        function desselecionarTodos() {
            document.querySelectorAll('#gerenteTableBody input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('selectAllGerente').checked = false;
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        // Listener para respostas do template (ACEITO/RECUSO)
        window.addEventListener('message', async function(event) {
            if (event.data && event.data.type === 'template_response') {
                const { telefone, resposta } = event.data;
                
                try {
                    await fetch(`${CONFIG.N8N_WEBHOOK}/resposta-template`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            telefone: telefone,
                            resposta: resposta,
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    console.log(`Resposta registrada: ${telefone} - ${resposta}`);
                } catch (error) {
                    console.error('Erro ao registrar resposta:', error);
                }
            }
        });
    </script>
</body>
</html>
