<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Escalas - FLAP (v4 Final)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: 80vh;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .test-mode {
            background: #ffc107;
            color: #000;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-badge {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .btn-logout {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Login simplificado */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .login-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 1.5rem;
        }

        .quick-login {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        /* Dashboard */
        .dashboard {
            padding: 20px;
        }

        .dashboard-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
        }

        .modal-header {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-footer .btn {
            width: auto;
            padding: 10px 20px;
        }

        .hidden {
            display: none !important;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.info {
            background: #17a2b8;
        }

        .loading {
            color: #6c757d;
            font-style: italic;
        }

        .badge {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }

        .badge.success {
            background: #28a745;
        }

        .badge.warning {
            background: #ffc107;
            color: #212529;
        }
    </style>
</head>
<body>
    <div class="test-mode">
        ‚ö†Ô∏è MODO DE TESTE - Sistema em Configura√ß√£o (v4 Final)
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h2 class="login-title">Sistema de Escalas - FLAP</h2>
        <div class="quick-login">
            <button class="btn btn-primary" onclick="loginAs('rh')">Entrar como RH</button>
            <button class="btn btn-success" onclick="loginAs('marcio')">Entrar como MARCIO</button>
            <button class="btn btn-success" onclick="loginAs('joao')">Entrar como JO√ÉO</button>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainContainer" class="container hidden">
        <div class="header">
            <h1>Sistema de Escalas - FLAP</h1>
            <div class="user-info">
                <span class="user-badge" id="userBadge"></span>
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>
        </div>

        <!-- RH Dashboard -->
        <div id="rhDashboard" class="dashboard hidden">
            <h2 class="dashboard-title">Dashboard RH</h2>
            
            <div class="cards-grid">
                <div class="card">
                    <div class="card-title">Demanda Atual</div>
                    <div id="currentDemand">
                        <span class="loading">Carregando...</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Escalas Recebidas</div>
                    <div id="receivedScales">
                        <span class="loading">Calculando...</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Total de Profissionais</div>
                    <div id="totalSelected">
                        <span class="loading">Calculando...</span>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="openCreateDemand()">Criar Nova Demanda</button>
                <button class="btn btn-primary" onclick="verEscalaUnificada()">Ver Escala Unificada</button>
                <button class="btn btn-info" onclick="atualizarDados()">üîÑ Atualizar Dados</button>
                <button class="btn btn-warning" onclick="enviarConvocacao()">Enviar Convoca√ß√£o (Teste)</button>
                <button class="btn btn-warning" onclick="notificarGerentes()">Notificar Gerentes (Teste)</button>
                <button class="btn btn-danger" onclick="encerrarDemanda()">Encerrar Demanda</button>
            </div>

            <div id="unifiedTable" class="table-container hidden">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" onchange="toggleAll()"></th>
                            <th>Nome</th>
                            <th>Telefone</th>
                            <th>Fun√ß√£o</th>
                            <th>Gerente</th>
                            <th>Status RH</th>
                            <th>Resposta</th>
                        </tr>
                    </thead>
                    <tbody id="unifiedTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center;">
                                <span class="loading">Carregando dados...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Gerente Dashboard -->
        <div id="gerenteDashboard" class="dashboard hidden">
            <h2 class="dashboard-title">Dashboard Gerente - <span id="gerenteName"></span></h2>
            
            <div class="card">
                <div class="card-title">Demanda Atual</div>
                <div id="gerenteDemandInfo">
                    <span class="loading">Carregando demanda...</span>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="selecionarTodos()">Selecionar Todos</button>
                <button class="btn btn-primary" onclick="desselecionarTodos()">Desselecionar Todos</button>
                <button class="btn btn-success" onclick="enviarEscala()">Enviar Escala</button>
                <button class="btn btn-warning" onclick="recarregarDemanda()">Recarregar Demanda</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllGerente" onchange="toggleAllGerente()"></th>
                            <th>Nome</th>
                            <th>Telefone</th>
                            <th>Fun√ß√£o</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="gerenteTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Criar Demanda -->
    <div id="createDemandModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Criar Nova Demanda</div>
            <form id="createDemandForm">
                <div class="form-group">
                    <label for="local">Local:</label>
                    <select id="local" required>
                        <option value="">Selecione...</option>
                        <option value="Estadio Nilton Santos">Est√°dio Nilton Santos</option>
                        <option value="Sao Januario">S√£o Janu√°rio</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="evento">Evento:</label>
                    <input type="text" id="evento" placeholder="Ex: Botafogo x Flamengo - Campeonato Brasileiro" required>
                </div>
                <div class="form-group">
                    <label for="dataEvento">Data do Evento:</label>
                    <input type="datetime-local" id="dataEvento" required>
                </div>
                <div class="form-group">
                    <label for="dataLimite">Data Limite para Escala:</label>
                    <input type="datetime-local" id="dataLimite" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('createDemandModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Criar Demanda</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Configura√ß√µes
        const CONFIG = {
            SHEETS_API_KEY: 'AIzaSyCCvdIC0TnINvn5s3TPwufzos-6sxZYFHk',
            UNIFIED_SHEET_ID: '1LjjOs91sTY72xbCVKS_nK8cyY8sWEJa1cV_JNLsYszM',
            MARCIO_SHEET_ID: '1SvKZBZ3FdZRFk5iXxg26WFqMgMiyqMAmQt2VzCY31iY',
            JOAO_SHEET_ID: '1qxd-74E1VOJccO7FDOy18TX6VznvNTfHb7sSOcMTUI4',
            N8N_WEBHOOK: 'https://n8n.hublanup.com.br/webhook',
            NUMERO_TESTE: '5511953909792',
            TEMPLATE_ID: '68cc74d8ae6ca49eaf1c334e'
        };

        // Dados compartilhados
        const SHARED_DATA = {
            demandaAtual: null,
            dadosUnificados: [],
            gerentes: {
                marcio: [
                    { nome: 'CARLOS SILVA', telefone: '11953909792', funcao: 'SEGURAN√áA', status: 'ATIVO' },
                    { nome: 'ANA COSTA', telefone: '11999999992', funcao: 'AUXILIAR', status: 'ATIVO' },
                    { nome: 'PEDRO SANTOS', telefone: '11999999993', funcao: 'COORDENADOR', status: 'ATIVO' }
                ],
                joao: [
                    { nome: 'MARIA OLIVEIRA', telefone: '11999999994', funcao: 'SEGURAN√áA', status: 'ATIVO' },
                    { nome: 'JO√ÉO SOUZA', telefone: '11999999995', funcao: 'AUXILIAR', status: 'ATIVO' },
                    { nome: 'LUCAS LIMA', telefone: '11999999996', funcao: 'SUPERVISOR', status: 'ATIVO' }
                ]
            }
        };

        let currentUser = null;
        let selectedProfessionals = new Set();

        // Setup inicial
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('createDemandForm').addEventListener('submit', handleCreateDemand);
            console.log('Sistema de Escalas FLAP v4 Final - Carregado');
        });

        // Login
        function loginAs(type) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('hidden');
            
            if (type === 'rh') {
                currentUser = { type: 'rh', name: 'RH' };
                document.getElementById('rhDashboard').classList.remove('hidden');
                loadRHDashboard();
            } else {
                currentUser = { type: 'gerente', name: type.toUpperCase() };
                document.getElementById('gerenteDashboard').classList.remove('hidden');
                document.getElementById('gerenteName').textContent = currentUser.name;
                loadGerenteData(type);
            }
            
            document.getElementById('userBadge').textContent = currentUser.name;
            showToast(`Logado como ${currentUser.name}`, 'success');
        }

        function logout() {
            location.reload();
        }

        // Fun√ß√£o para carregar demanda ativa
        async function loadDemandaAtiva() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.UNIFIED_SHEET_ID}/values/eventos_criados?key=${CONFIG.SHEETS_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    // Procurar por demanda ativa come√ßando do fim
                    for (let i = data.values.length - 1; i >= 1; i--) {
                        const row = data.values[i];
                        const status = row[5] || '';
                        
                        if (status.toUpperCase().trim() === 'ATIVO') {
                            SHARED_DATA.demandaAtual = {
                                local: row[0] || '',
                                evento: row[1] || '',
                                dataEvento: row[2] || '',
                                dataLimite: row[3] || '',
                                dataCriacao: row[4] || '',
                                status: row[5] || ''
                            };
                            console.log('Demanda ativa encontrada:', SHARED_DATA.demandaAtual);
                            return true;
                        }
                    }
                }
                
                SHARED_DATA.demandaAtual = null;
                return false;
                
            } catch (error) {
                console.error('Erro ao carregar demanda:', error);
                return false;
            }
        }

        // Fun√ß√£o para carregar dados unificados
        async function carregarDadosUnificados() {
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.UNIFIED_SHEET_ID}/values/Dados_unificados?key=${CONFIG.SHEETS_API_KEY}`
                );
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    SHARED_DATA.dadosUnificados = data.values.slice(1);
                    
                    // Contar gerentes √∫nicos
                    const gerentesUnicos = [...new Set(SHARED_DATA.dadosUnificados.map(r => r[3]).filter(g => g))];
                    
                    // Atualizar contadores
                    document.getElementById('receivedScales').innerHTML = 
                        `<strong>${gerentesUnicos.length}</strong> escalas recebidas`;
                    document.getElementById('totalSelected').innerHTML = 
                        `<strong>${SHARED_DATA.dadosUnificados.length}</strong> profissionais`;
                    
                    console.log(`Dados unificados carregados: ${SHARED_DATA.dadosUnificados.length} profissionais`);
                } else {
                    SHARED_DATA.dadosUnificados = [];
                    document.getElementById('receivedScales').innerHTML = '<strong>0</strong> escalas recebidas';
                    document.getElementById('totalSelected').innerHTML = '<strong>0</strong> profissionais';
                }
            } catch (error) {
                console.error('Erro ao carregar dados unificados:', error);
                document.getElementById('receivedScales').innerHTML = 'Erro ao carregar';
                document.getElementById('totalSelected').innerHTML = 'Erro ao carregar';
            }
        }

        // RH Functions
        async function loadRHDashboard() {
            document.getElementById('currentDemand').innerHTML = '<span class="loading">Carregando...</span>';
            document.getElementById('receivedScales').innerHTML = '<span class="loading">Calculando...</span>';
            document.getElementById('totalSelected').innerHTML = '<span class="loading">Calculando...</span>';
            
            // Carregar demanda ativa
            const hasDemanda = await loadDemandaAtiva();
            
            if (hasDemanda && SHARED_DATA.demandaAtual) {
                updateDemandDisplay();
            } else {
                document.getElementById('currentDemand').innerHTML = 'Nenhuma demanda ativa';
            }
            
            // Carregar dados unificados automaticamente
            await carregarDadosUnificados();
        }

        function updateDemandDisplay() {
            if (SHARED_DATA.demandaAtual) {
                const demandaHtml = `
                    <strong>${SHARED_DATA.demandaAtual.evento}</strong><br>
                    Local: ${SHARED_DATA.demandaAtual.local}<br>
                    Data Evento: ${SHARED_DATA.demandaAtual.dataEvento}<br>
                    Data Limite: ${SHARED_DATA.demandaAtual.dataLimite}<br>
                    Status: <span style="color: green;">${SHARED_DATA.demandaAtual.status}</span>
                `;
                
                // Atualizar display do RH
                if (document.getElementById('currentDemand')) {
                    document.getElementById('currentDemand').innerHTML = demandaHtml;
                }
                
                // Atualizar display do gerente
                if (document.getElementById('gerenteDemandInfo')) {
                    document.getElementById('gerenteDemandInfo').innerHTML = demandaHtml;
                }
            }
        }

        // Atualizar dados manualmente
        async function atualizarDados() {
            showToast('Atualizando dados...', 'info');
            await loadRHDashboard();
            showToast('Dados atualizados!', 'success');
        }

        // Ver escala unificada
        async function verEscalaUnificada() {
            const table = document.getElementById('unifiedTable');
            table.classList.toggle('hidden');
            
            if (!table.classList.contains('hidden')) {
                // Atualizar tabela com dados j√° carregados
                atualizarTabelaUnificada();
                
                // Recarregar dados mais recentes
                await carregarDadosUnificados();
                atualizarTabelaUnificada();
            }
        }

        function atualizarTabelaUnificada() {
            const tbody = document.getElementById('unifiedTableBody');
            
            if (SHARED_DATA.dadosUnificados.length > 0) {
                tbody.innerHTML = SHARED_DATA.dadosUnificados.map((row, index) => `
                    <tr>
                        <td><input type="checkbox" value="${index}" onchange="toggleSelection(${index})"></td>
                        <td>${row[0] || ''}</td>
                        <td>${row[1] || ''}</td>
                        <td>${row[2] || ''}</td>
                        <td>${row[3] || ''}</td>
                        <td>
                            <span class="badge ${row[5] === 'APROVADO' ? 'success' : 'warning'}">
                                ${row[5] || 'PENDENTE'}
                            </span>
                        </td>
                        <td>${row[8] || '-'}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhuma escala recebida ainda</td></tr>';
            }
        }

        function openCreateDemand() {
            document.getElementById('createDemandModal').classList.add('show');
        }

        async function handleCreateDemand(e) {
            e.preventDefault();
            
            const formData = {
                local: document.getElementById('local').value,
                evento: document.getElementById('evento').value,
                dataEvento: document.getElementById('dataEvento').value,
                dataLimite: document.getElementById('dataLimite').value,
                dataCriacao: new Date().toISOString(),
                status: 'ATIVO'
            };
            
            try {
                showToast('Criando demanda...', 'info');
                
                const response = await fetch(`${CONFIG.N8N_WEBHOOK}/criar-demanda`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showToast('Demanda criada com sucesso!', 'success');
                    closeModal('createDemandModal');
                    SHARED_DATA.demandaAtual = formData;
                    updateDemandDisplay();
                    document.getElementById('createDemandForm').reset();
                }
            } catch (error) {
                console.error(error);
                showToast('Erro ao criar demanda (verifique o n8n)', 'error');
                // Salvar localmente mesmo com erro
                SHARED_DATA.demandaAtual = formData;
                updateDemandDisplay();
                closeModal('createDemandModal');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Gerente Functions
        async function loadGerenteData(gerente) {
            document.getElementById('gerenteDemandInfo').innerHTML = '<span class="loading">Carregando demanda...</span>';
            
            // Carregar demanda ativa
            const hasDemanda = await loadDemandaAtiva();
            
            if (hasDemanda && SHARED_DATA.demandaAtual) {
                updateDemandDisplay();
            } else {
                document.getElementById('gerenteDemandInfo').innerHTML = 
                    '<span style="color: #6c757d;">Nenhuma demanda ativa</span>';
            }
            
            // Carregar profissionais do gerente
            const tbody = document.getElementById('gerenteTableBody');
            const data = SHARED_DATA.gerentes[gerente] || [];
            
            tbody.innerHTML = data.map((prof, index) => `
                <tr>
                    <td><input type="checkbox" value="${index}"></td>
                    <td>${prof.nome}</td>
                    <td>${prof.telefone}</td>
                    <td>${prof.funcao}</td>
                    <td>${prof.status}</td>
                </tr>
            `).join('');
        }

        async function recarregarDemanda() {
            showToast('Recarregando demanda...', 'info');
            document.getElementById('gerenteDemandInfo').innerHTML = '<span class="loading">Carregando...</span>';
            
            const hasDemanda = await loadDemandaAtiva();
            
            if (hasDemanda && SHARED_DATA.demandaAtual) {
                updateDemandDisplay();
                showToast('Demanda atualizada!', 'success');
            } else {
                document.getElementById('gerenteDemandInfo').innerHTML = 
                    '<span style="color: #6c757d;">Nenhuma demanda ativa</span>';
                showToast('Nenhuma demanda encontrada', 'info');
            }
        }

        // Notificar gerentes
        async function notificarGerentes() {
            if (!SHARED_DATA.demandaAtual) {
                showToast('Crie uma demanda primeiro', 'error');
                return;
            }
            
            try {
                showToast('Notificando gerentes...', 'info');
                
                const response = await fetch(`${CONFIG.N8N_WEBHOOK}/notificar-gerentes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        evento: SHARED_DATA.demandaAtual.evento,
                        dataLimite: SHARED_DATA.demandaAtual.dataLimite,
                        local: SHARED_DATA.demandaAtual.local,
                        numeroTeste: CONFIG.NUMERO_TESTE
                    })
                });
                
                showToast('Notifica√ß√£o enviada!', 'success');
            } catch (error) {
                console.error(error);
                showToast('Erro ao notificar', 'error');
            }
        }

        // CORRE√á√ÉO: Fun√ß√£o enviarConvocacao
// Substitua a fun√ß√£o enviarConvocacao no seu HTML por esta vers√£o corrigida:

async function enviarConvocacao() {
    // Verificar se h√° profissionais selecionados
    const checkboxes = document.querySelectorAll('#unifiedTableBody input[type="checkbox"]:checked');
    
    if (checkboxes.length === 0) {
        showToast('Selecione pelo menos um profissional na tabela', 'error');
        return;
    }
    
    if (!SHARED_DATA.demandaAtual) {
        showToast('Nenhuma demanda ativa', 'error');
        return;
    }
    
    // Coletar dados dos profissionais selecionados
    const profissionaisSelecionados = [];
    checkboxes.forEach(cb => {
        const index = parseInt(cb.value);
        const row = SHARED_DATA.dadosUnificados[index];
        if (row) {
            profissionaisSelecionados.push({
                nome: row[0],      // Nome
                telefone: row[1],  // Telefone
                funcao: row[2],    // Fun√ß√£o
                gerente: row[3]    // Gerente
            });
        }
    });
    
    if (profissionaisSelecionados.length === 0) {
        showToast('Erro ao coletar dados dos profissionais', 'error');
        return;
    }
    
    // Confirmar envio
    const confirmMessage = `Enviar convoca√ß√£o para ${profissionaisSelecionados.length} profissional(is)?`;
    if (!confirm(confirmMessage)) {
        return;
    }
    
    try {
        showToast(`Enviando convoca√ß√£o para ${profissionaisSelecionados.length} profissional(is)...`, 'info');
        
        // Enviar para o n8n
        const response = await fetch(`${CONFIG.N8N_WEBHOOK}/enviar-convocacao`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                demanda: {
                    evento: SHARED_DATA.demandaAtual.evento,
                    local: SHARED_DATA.demandaAtual.local,
                    dataEvento: SHARED_DATA.demandaAtual.dataEvento,
                    dataLimite: SHARED_DATA.demandaAtual.dataLimite
                },
                profissionais: profissionaisSelecionados,
                timestamp: new Date().toISOString()
            })
        });
        
        if (response.ok) {
            showToast(`Convoca√ß√£o enviada para ${profissionaisSelecionados.length} profissional(is)!`, 'success');
            
            // Desmarcar checkboxes ap√≥s envio
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('selectAll').checked = false;
            selectedProfessionals.clear();
        } else {
            throw new Error('Erro na resposta do servidor');
        }
    } catch (error) {
        console.error('Erro ao enviar convoca√ß√£o:', error);
        showToast('Erro ao enviar convoca√ß√£o. Verifique o n8n.', 'error');
    }
}

        // Encerrar demanda
        async function encerrarDemanda() {
            if (!SHARED_DATA.demandaAtual) {
                showToast('Nenhuma demanda ativa', 'error');
                return;
            }
            
            if (confirm('Deseja realmente encerrar a demanda?')) {
                try {
                    const response = await fetch(`${CONFIG.N8N_WEBHOOK}/encerrar-demanda`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            demandaId: SHARED_DATA.demandaAtual.evento,
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    showToast('Demanda encerrada', 'success');
                    SHARED_DATA.demandaAtual = null;
                    document.getElementById('currentDemand').innerHTML = 'Nenhuma demanda ativa';
                } catch (error) {
                    console.error(error);
                    showToast('Erro ao encerrar demanda', 'error');
                }
            }
        }

        // Enviar escala (gerente)
        async function enviarEscala() {
            const checkboxes = document.querySelectorAll('#gerenteTableBody input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                showToast('Selecione pelo menos um profissional', 'error');
                return;
            }
            
            if (!SHARED_DATA.demandaAtual) {
                showToast('Nenhuma demanda ativa', 'error');
                return;
            }
            
            try {
                showToast('Enviando escala...', 'info');
                
                const gerente = currentUser.name.toLowerCase();
                const selected = Array.from(checkboxes).map(cb => 
                    SHARED_DATA.gerentes[gerente][cb.value]
                );
                
                const response = await fetch(`${CONFIG.N8N_WEBHOOK}/enviar-escala-gerente`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        gerente: currentUser.name,
                        demandaId: SHARED_DATA.demandaAtual.evento,
                        profissionais: selected,
                        timestamp: new Date().toISOString()
                    })
                });
                
                showToast('Escala enviada com sucesso!', 'success');
                desselecionarTodos();
            } catch (error) {
                console.error(error);
                showToast('Erro ao enviar escala', 'error');
            }
        }

        // Fun√ß√µes de sele√ß√£o
        function toggleSelection(index) {
            if (selectedProfessionals.has(index)) {
                selectedProfessionals.delete(index);
            } else {
                selectedProfessionals.add(index);
            }
        }

        function toggleAll() {
            const checkboxes = document.querySelectorAll('#unifiedTableBody input[type="checkbox"]');
            const selectAll = document.getElementById('selectAll');
            
            checkboxes.forEach((cb, index) => {
                cb.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedProfessionals.add(index);
                } else {
                    selectedProfessionals.delete(index);
                }
            });
        }

        function toggleAllGerente() {
            const selectAll = document.getElementById('selectAllGerente');
            document.querySelectorAll('#gerenteTableBody input[type="checkbox"]').forEach(cb => {
                cb.checked = selectAll.checked;
            });
        }

        function selecionarTodos() {
            document.querySelectorAll('#gerenteTableBody input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            document.getElementById('selectAllGerente').checked = true;
        }

        function desselecionarTodos() {
            document.querySelectorAll('#gerenteTableBody input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('selectAllGerente').checked = false;
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>
